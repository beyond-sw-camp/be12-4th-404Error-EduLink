pipeline {
    agent any

    environment {
        IMAGE_NAME = 'mstar228/edulink-frontend'
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        KUBE_HOST = 'test@192.0.2.7'
        PATH = "/usr/local/bin:${env.PATH}"
    }

    stages {
        stage('Git Clone') {
            steps {
                echo "Cloning Repository"
                git url: 'https://github.com/beyond-sw-camp/be12-4th-404Error-EduLink.git',
                    branch: "${env.GIT_BRANCH.replace('origin/', '')}"
            }
        }
        stage('Build Frontend') {
            steps {
                echo "Building Frontend"
                sh '''
                    cd ${WORKSPACE}/frontend
                    npm install
                    npm run build
                '''
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker Image ${IMAGE_NAME}:${IMAGE_TAG}"
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "${WORKSPACE}/frontend")
                }
            }
        }
        stage('Push to Registry') {
            steps {
                script {
                    echo "Pushing Docker Image ${IMAGE_NAME}:${IMAGE_TAG} to Registry"
                    withDockerRegistry([credentialsId: 'DOCKER_HUB']) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                    }
                }
            }
        }
        stage('Determine Deploy Color') {
            steps {
                script {
                    // 각각의 배포의 레플리카 수를 조회
                    def blueReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-blue -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()
                    def greenReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-green -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()

                    int blueCount = 0
                    int greenCount = 0
                    try {
                        blueCount = blueReplicas.toInteger()
                    } catch (Exception e) {
                        blueCount = 0
                    }
                    try {
                        greenCount = greenReplicas.toInteger()
                    } catch (Exception e) {
                        greenCount = 0
                    }

                    echo "Blue deployment replicas: ${blueCount}"
                    echo "Green deployment replicas: ${greenCount}"

                    def deployColor = ''
                    def otherColor = ''

                    if (blueCount > 0 && greenCount == 0) {
                        // 현재 blue가 활성화되어 있으면 green 배포
                        deployColor = "green"
                        otherColor = "blue"
                    } else if (greenCount > 0 && blueCount == 0) {
                        // 현재 green이 활성화되어 있으면 blue 배포
                        deployColor = "blue"
                        otherColor = "green"
                    } else if (blueCount > 0 && greenCount > 0) {
                        // 두 배포 모두 활성화되어 있다면, 간단하게 blue의 반대인 green을 선택 (필요시 로직 조정)
                        deployColor = "green"
                        otherColor = "blue"
                    } else {
                        // 활성 배포가 없을 경우 기본값: blue 배포
                        deployColor = "blue"
                        otherColor = "green"
                    }

                    echo "Deploying ${deployColor} version (scaling down ${otherColor})"
                    env.DEPLOY_COLOR = deployColor
                    env.OTHER_COLOR = otherColor
                }
            }
        }
        stage('Deploy Blue-Green') {
            steps {
                script {
                    // 로컬 deployment YAML 파일 내 'latest' 태그를 현재 이미지 태그로 변경
                    sh """
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml
                    """
                    // 로컬 파일 확인 (디버깅용)
                    sh "ls -la ${WORKSPACE}/frontend/k8s"

                    // 수정한 YAML 파일을 원격 호스트로 전송
                    sh """
                        scp ${WORKSPACE}/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml ${KUBE_HOST}:/home/test/frontend/k8s/
                    """
                    // 원격 호스트에서 config, service, 그리고 선택된 deployment 적용
                    sh """
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-conf.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-svc.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml'
                    """
                    // 배포된 Deployment의 롤아웃 상태 대기
                    sh "ssh ${KUBE_HOST} 'kubectl rollout status deployment/frontend-deployment-${env.DEPLOY_COLOR}'"
                    // 반대 색상의 Deployment 스케일 다운 (오류 발생 시 무시)
                    sh "ssh ${KUBE_HOST} 'kubectl scale deployment frontend-deployment-${env.OTHER_COLOR} --replicas=0' || true"
                }
            }
        }
        // 추가 검증 단계: 배포 후 헬스체크 또는 smoke test
        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment health..."
                    // 예시: 헬스체크 엔드포인트 호출
                    // sh "curl -f http://your-frontend-url/health"
                }
            }
        }
    }
}
