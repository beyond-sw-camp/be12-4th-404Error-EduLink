pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        IMAGE_NAME = 'mstar228/edulink-frontend'
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        KUBE_HOST = 'test@192.0.2.7'
        PATH = "/usr/local/bin:${env.PATH}"
    }

    stages {
        stage('Start Timer') {
            steps {
                script {
                    startTime = System.currentTimeMillis()
                }
            }
        }

        stage('Git Clone') {
            steps {
                echo "Cloning Repository"
                git url: 'https://github.com/beyond-sw-camp/be12-4th-404Error-EduLink.git',
                    branch: "${env.GIT_BRANCH.replace('origin/', '')}"
            }
            post {
                success {
                    sendDiscordMessage("âœ… Git Clone ì„±ê³µ!", "Git Repository í´ë¡  ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Git Clone ì‹¤íŒ¨!", "Git Repository í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Build Frontend') {
            steps {
                echo "Building Frontend"
                sh '''
                    cd ${WORKSPACE}/frontend
                    npm install
                    npm run build
                '''
            }
            post {
                success {
                    sendDiscordMessage("âœ… Frontend Build ì„±ê³µ!", "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Frontend Build ì‹¤íŒ¨!", "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker Image ${IMAGE_NAME}:${IMAGE_TAG}"
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "${WORKSPACE}/frontend")
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Build ì„±ê³µ!", "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Build ì‹¤íŒ¨!", "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    echo "Pushing Docker Image ${IMAGE_NAME}:${IMAGE_TAG} to Registry"
                    withDockerRegistry([credentialsId: 'DOCKER_HUB']) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                    }
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Push ì„±ê³µ!", "ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë¡œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Push ì‹¤íŒ¨!", "ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Determine Deploy Color') {
            when {
                expression { env.GIT_BRANCH == 'origin/kms/main' }
            }
            steps {
                script {
                    def blueReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-blue -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()
                    def greenReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-green -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()

                    int blueCount = 0
                    int greenCount = 0
                    try { blueCount = blueReplicas.toInteger() } catch (Exception e) { blueCount = 0 }
                    try { greenCount = greenReplicas.toInteger() } catch (Exception e) { greenCount = 0 }

                    echo "Blue deployment replicas: ${blueCount}"
                    echo "Green deployment replicas: ${greenCount}"

                    def deployColor = (blueCount > 0 && greenCount == 0) ? "green" : (greenCount > 0 && blueCount == 0) ? "blue" : (blueCount > 0 && greenCount > 0) ? "green" : "blue"
                    def otherColor = (deployColor == "blue") ? "green" : "blue"

                    echo "Deploying ${deployColor} version (scaling down ${otherColor})"
                    env.DEPLOY_COLOR = deployColor
                    env.OTHER_COLOR = otherColor
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë°°í¬ ìƒ‰ìƒ ê²°ì • ì™„ë£Œ!", "${env.DEPLOY_COLOR}ë¡œ ë°°í¬ ì§„í–‰ ì˜ˆì •", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ ë°°í¬ ìƒ‰ìƒ ê²°ì • ì‹¤íŒ¨!", "replica í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Deploy Blue-Green') {
            when {
                expression { env.GIT_BRANCH == 'origin/kms/main' }
            }
            steps {
                script {
                    sh """
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml
                        scp ${WORKSPACE}/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml ${KUBE_HOST}:/home/test/frontend/k8s/
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-conf.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-svc.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-deployment-${env.DEPLOY_COLOR}.yml'
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/frontend-deployment-${env.DEPLOY_COLOR}'
                        ssh ${KUBE_HOST} 'kubectl scale deployment frontend-deployment-${env.OTHER_COLOR} --replicas=0' || true
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Blue-Green ë°°í¬ ì„±ê³µ!", "${env.DEPLOY_COLOR}ë¡œ íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Blue-Green ë°°í¬ ì‹¤íŒ¨!", "ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment health..."
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë°°í¬ ê²€ì¦ ì„±ê³µ!", "í—¬ìŠ¤ì²´í¬ í†µê³¼", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨!", "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨", "RED")
                }
            }
        }

        stage('End Timer') {
            steps {
                script {
                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    echo "â±ï¸ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ"
                }
            }
        }
    }

    post {
        success {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
                    discordSend(
                        description: """
                        ğŸ“¦ *${currentBuild.displayName}*
                        âœ… ì„±ê³µ
                        â±ï¸ ì‹¤í–‰ ì‹œê°„: *${duration}ì´ˆ*
                        """,
                        link: env.BUILD_URL,
                        result: currentBuild.currentResult,
                        title: "ğŸ‰ ${env.JOB_NAME} ë°°í¬ ì„±ê³µ",
                        webhookURL: "$DISCORD"
                    )
                }
            }
        }
        failure {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
                    discordSend(
                        description: """
                        ğŸ“¦ *${currentBuild.displayName}*
                        âŒ ì‹¤íŒ¨
                        â±ï¸ ì‹¤í–‰ ì‹œê°„: *${duration}ì´ˆ*
                        """,
                        link: env.BUILD_URL,
                        result: currentBuild.currentResult,
                        title: "ğŸš¨ ${env.JOB_NAME} ë°°í¬ ì‹¤íŒ¨",
                        webhookURL: "$DISCORD"
                    )
                }
            }
        }
    }
}

def sendDiscordMessage(String title, String description, String color) {
    withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
        discordSend(
            description: description,
            footer: "Jenkins CI/CD",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            title: title,
            color: color,
            webhookURL: "$DISCORD"
        )
    }
}